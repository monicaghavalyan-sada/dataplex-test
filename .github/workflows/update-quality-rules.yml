name: Update Dataplex Quality Scans

on:
  push:
    branches:
      - main
    paths:
      - 'config-yamls/**/*.yaml'
  workflow_dispatch:

env:
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GCP_REGION: ${{ vars.GCP_REGION }}
  BUCKET_NAME: ${{ vars.BUCKET_NAME }}

jobs:
  update-quality-scans:
    name: Process Changed YAML Files
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v3
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Get Changed Folders
        id: changed-folders
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '^config-yamls/.*\.yaml$' || true)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "folders=" >> $GITHUB_OUTPUT
          else
            FOLDERS=$(echo "$CHANGED_FILES" | sed 's|/[^/]*$||' | sort -u)
            FOLDERS_JSON=$(echo "$FOLDERS" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "folders=$FOLDERS_JSON" >> $GITHUB_OUTPUT
            
            echo "$CHANGED_FILES" > /tmp/changed_files.txt
          fi
      
      - name: Process Each Folder
        if: steps.changed-folders.outputs.folders != ''
        run: |
          FOLDERS='${{ steps.changed-folders.outputs.folders }}'
          
          echo "$FOLDERS" | jq -r '.[]' | while read -r FOLDER; do
            FOLDER_NAME=$(basename "$FOLDER")
            
            SCAN_NAME=$(echo "$FOLDER_NAME" | \
              tr '[:upper:]' '[:lower:]' | \
              sed 's/[^a-z0-9-]/-/g' | \
              sed 's/-\+/-/g' | \
              sed 's/^-//;s/-$//')-scan
            
            echo "Processing folder: $FOLDER_NAME -> $SCAN_NAME"
            
            if [ ! -f "$FOLDER/config.yaml" ] || [ ! -f "$FOLDER/rules.yaml" ]; then
              echo "ERROR: Missing config.yaml or rules.yaml in $FOLDER"
              exit 1
            fi
            
            python3 -c "import yaml; yaml.safe_load(open('$FOLDER/config.yaml'))" || exit 1
            python3 -c "import yaml; yaml.safe_load(open('$FOLDER/rules.yaml'))" || exit 1
            
            DATASET=$(python3 -c "import yaml; print(yaml.safe_load(open('$FOLDER/config.yaml'))['dataset'])")
            TABLE=$(python3 -c "import yaml; print(yaml.safe_load(open('$FOLDER/config.yaml'))['table'])")
            SCHEDULE=$(python3 -c "import yaml; print(yaml.safe_load(open('$FOLDER/config.yaml'))['schedule'])")
            DESCRIPTION=$(python3 -c "import yaml; print(yaml.safe_load(open('$FOLDER/config.yaml'))['description'])")
            DISPLAY_NAME=$(python3 -c "import yaml; print(yaml.safe_load(open('$FOLDER/config.yaml'))['display_name'])")
            
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            gsutil cp "$FOLDER/rules.yaml" "gs://${BUCKET_NAME}/config-yamls/${FOLDER_NAME}/rules.yaml"
            gsutil cp "$FOLDER/config.yaml" "gs://${BUCKET_NAME}/config-yamls/${FOLDER_NAME}/config.yaml"
            gsutil cp "$FOLDER/rules.yaml" "gs://${BUCKET_NAME}/config-yamls/${FOLDER_NAME}/backups/rules_${TIMESTAMP}.yaml"
            gsutil cp "$FOLDER/config.yaml" "gs://${BUCKET_NAME}/config-yamls/${FOLDER_NAME}/backups/config_${TIMESTAMP}.yaml"
            
            CONFIG_CHANGED=$(grep -q "$FOLDER/config.yaml" /tmp/changed_files.txt && echo "true" || echo "false")
            
            if [ "$CONFIG_CHANGED" = "true" ]; then
              echo "Config changed - recreating scan"
              
              if gcloud dataplex datascans describe "$SCAN_NAME" \
                  --location="${GCP_REGION}" \
                  --project="${GCP_PROJECT_ID}" &>/dev/null; then
                gcloud dataplex datascans delete "$SCAN_NAME" \
                  --location="${GCP_REGION}" \
                  --project="${GCP_PROJECT_ID}" \
                  --quiet
                echo "Deleted: $SCAN_NAME"
                sleep 300
              fi
              
              gcloud dataplex datascans create data-quality "$SCAN_NAME" \
                --location="${GCP_REGION}" \
                --project="${GCP_PROJECT_ID}" \
                --data-source-resource="//bigquery.googleapis.com/projects/${GCP_PROJECT_ID}/datasets/${DATASET}/tables/${TABLE}" \
                --data-quality-spec-file="gs://${BUCKET_NAME}/config-yamls/${FOLDER_NAME}/rules.yaml" \
                --schedule="$SCHEDULE" \
                --description="$DESCRIPTION" \
                --display-name="$DISPLAY_NAME"
              
              echo "Created: $SCAN_NAME"
            else
              echo "Only rules changed - updating scan"
              
              if gcloud dataplex datascans describe "$SCAN_NAME" \
                  --location="${GCP_REGION}" \
                  --project="${GCP_PROJECT_ID}" &>/dev/null; then
                
                gcloud dataplex datascans update data-quality "$SCAN_NAME" \
                  --location="${GCP_REGION}" \
                  --project="${GCP_PROJECT_ID}" \
                  --data-quality-spec-file="$FOLDER/rules.yaml"
                
                echo "Updated: $SCAN_NAME"
              else
                echo "Scan does not exist - creating"
                
                gcloud dataplex datascans create data-quality "$SCAN_NAME" \
                  --location="${GCP_REGION}" \
                  --project="${GCP_PROJECT_ID}" \
                  --data-source-resource="//bigquery.googleapis.com/projects/${GCP_PROJECT_ID}/datasets/${DATASET}/tables/${TABLE}" \
                  --data-quality-spec-file="gs://${BUCKET_NAME}/config-yamls/${FOLDER_NAME}/rules.yaml" \
                  --schedule="$SCHEDULE" \
                  --description="$DESCRIPTION" \
                  --display-name="$DISPLAY_NAME"
                
                echo "Created: $SCAN_NAME"
              fi
            fi
          done
