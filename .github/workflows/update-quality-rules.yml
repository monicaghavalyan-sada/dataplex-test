name: Update Dataplex Quality Rules

on:
  push:
    branches:
      - main
    paths:
      - 'quality_rules.yaml'
  workflow_dispatch:

env:
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GCP_REGION: ${{ vars.GCP_REGION }}
  BUCKET_NAME: ${{ vars.BUCKET_NAME }}
  SCAN_NAME: ${{ vars.SCAN_NAME }}

jobs:
  update-quality-rules:
    name: Upload YAML and Update Dataplex Scan
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v3
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          workload_identity_provider: 'projects/437177264669/locations/global/workloadIdentityPools/github/providers/my-repo'
          
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Validate YAML Syntax
        run: |
          echo "Validating YAML syntax"
          python3 -c "import yaml; yaml.safe_load(open('quality_rules.yaml'))"
          echo "Validation successful"
      
      - name: Upload to GCS
        run: |
          echo "Uploading quality_rules.yaml to GCS"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          gsutil cp quality_rules.yaml gs://${BUCKET_NAME}/quality_rules.yaml
          gsutil cp quality_rules.yaml gs://${BUCKET_NAME}/backups/quality_rules_${TIMESTAMP}.yaml
          echo "Upload complete"
      
      - name: Create or Update Dataplex Scan
        run: |
          echo "Checking if scan exists"
          
          # Check if scan exists
          if gcloud dataplex datascans describe sentiment-quality-scan \
              --location=us-central1 \
              --project=sada-tirayr &>/dev/null; then
            
            echo "Scan exists - updating"
            gcloud dataplex datascans update sentiment-quality-scan \
              --location=us-central1 \
              --project=sada-tirayr \
              --data-quality-spec-file=quality_rules.yaml
            echo "Update complete"
            
          else
            
            echo "Scan does not exist - creating"
            
            # First, upload YAML if not already there
            gsutil cp quality_rules.yaml gs://sada-tirayr-dataplex-sources/ 2>/dev/null || true
            
            # Create the scan
            gcloud dataplex datascans create sentiment-quality-scan \
              --location=us-central1 \
              --project=sada-tirayr \
              --data resource="//bigquery.googleapis.com/projects/sada-tirayr/datasets/sentiment_analysis/tables/product_sentiment_summary" \
              --data-quality-spec file=gs://sada-tirayr-dataplex-sources/quality_rules.yaml \
              --execution-spec trigger-schedule-cron="0 2 * * *" \
              --description="Daily data quality scan" \
              --display-name="Product Sentiment Quality Scan"
            
            echo "Create complete"
            
          fi
      
      - name: Trigger Scan Execution
        run: |
          echo "Triggering scan execution"
          gcloud dataplex datascans run ${SCAN_NAME} \
            --location=${GCP_REGION} \
            --project=${GCP_PROJECT_ID}
          echo "Scan triggered successfully"
