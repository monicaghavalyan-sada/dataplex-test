name: Update Dataplex Quality Rules

on:
  push:
    branches:
      - main
    paths:
      - 'quality_rules.yaml'
  workflow_dispatch:

env:
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GCP_REGION: ${{ vars.GCP_REGION }}
  BUCKET_NAME: ${{ vars.BUCKET_NAME }}
  SCAN_NAME: ${{ vars.SCAN_NAME }}

jobs:
  update-quality-rules:
    name: Upload YAML and Update Dataplex Scan
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v3
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          workload_identity_provider: 'projects/437177264669/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'github-actions-sa@sada-tirayr.iam.gserviceaccount.com'
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Validate YAML Syntax
        run: |
          echo "Validating YAML syntax"
          python3 -c "import yaml; yaml.safe_load(open('quality_rules.yaml'))"
          echo "Validation successful"
      
      - name: Upload to GCS
        run: |
          echo "Uploading quality_rules.yaml to GCS"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          gsutil cp quality_rules.yaml gs://${BUCKET_NAME}/quality_rules.yaml
          gsutil cp quality_rules.yaml gs://${BUCKET_NAME}/backups/quality_rules_${TIMESTAMP}.yaml
          echo "Upload complete"
      
      - name: Create or Update Scan
        run: |
          echo "Checking if scan exists"
          
          if gcloud dataplex datascans describe ${SCAN_NAME} \
              --location=${GCP_REGION} \
              --project=${GCP_PROJECT_ID} &>/dev/null; then
            
            echo "Scan exists - updating configuration"
            gcloud dataplex datascans update ${SCAN_NAME} \
              --location=${GCP_REGION} \
              --project=${GCP_PROJECT_ID} \
              --data-quality-spec-file=quality_rules.yaml
            
            echo "Scan updated successfully"
            
          else
            
            echo "Scan does not exist - creating new scan"
            gcloud dataplex datascans create data-quality ${SCAN_NAME} \
              --location=${GCP_REGION} \
              --project=${GCP_PROJECT_ID} \
              --data-source-resource="//bigquery.googleapis.com/projects/${GCP_PROJECT_ID}/datasets/sentiment_analysis/tables/product_sentiment_summary" \
              --data-quality-spec-file=gs://${BUCKET_NAME}/quality_rules.yaml \
              --schedule="0 2 * * *" \
              --description="Daily data quality scan" \
              --display-name="Product Sentiment Quality Scan"
            
            echo "Scan created successfully"
            
          fi
